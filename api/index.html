
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://GNS-Science.github.io/toshi-hazard-store/api/">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-6.2.8">
    
    
      
        <title>Modules - toshi-hazard-store</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="indigo" data-md-color-accent="indigo">
      
        <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script>
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#toshi_hazard_store" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://GNS-Science.github.io/toshi-hazard-store/" title="toshi-hazard-store" class="md-header-nav__button md-logo" aria-label="toshi-hazard-store">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            toshi-hazard-store
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Modules
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/GNS-Science/toshi-hazard-store" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GNS-Science/toshi-hazard-store
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://GNS-Science.github.io/toshi-hazard-store/" title="toshi-hazard-store" class="md-nav__button md-logo" aria-label="toshi-hazard-store">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    toshi-hazard-store
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/GNS-Science/toshi-hazard-store" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GNS-Science/toshi-hazard-store
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        Usage
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Modules
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Modules
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store" class="md-nav__link">
    toshi_hazard_store
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.config" class="md-nav__link">
    config
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.config.boolean_env" class="md-nav__link">
    boolean_env()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.gridded_hazard_query" class="md-nav__link">
    gridded_hazard_query
  </a>
  
    <nav class="md-nav" aria-label="gridded_hazard_query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.gridded_hazard_query.get_gridded_hazard" class="md-nav__link">
    get_gridded_hazard()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.gridded_hazard_query.get_one_gridded_hazard" class="md-nav__link">
    get_one_gridded_hazard()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.model" class="md-nav__link">
    model
  </a>
  
    <nav class="md-nav" aria-label="model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.drop_tables" class="md-nav__link">
    drop_tables()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.migrate" class="md-nav__link">
    migrate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard" class="md-nav__link">
    gridded_hazard
  </a>
  
    <nav class="md-nav" aria-label="gridded_hazard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.CompressedJsonicAttribute" class="md-nav__link">
    CompressedJsonicAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.CompressedListAttribute" class="md-nav__link">
    CompressedListAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.GriddedHazard" class="md-nav__link">
    GriddedHazard
  </a>
  
    <nav class="md-nav" aria-label="GriddedHazard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.GriddedHazard.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.drop_tables" class="md-nav__link">
    drop_tables()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.migrate" class="md-nav__link">
    migrate()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v1_model" class="md-nav__link">
    openquake_v1_model
  </a>
  
    <nav class="md-nav" aria-label="openquake_v1_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v1_model.LevelValuePairAttribute" class="md-nav__link">
    LevelValuePairAttribute
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v2_model" class="md-nav__link">
    openquake_v2_model
  </a>
  
    <nav class="md-nav" aria-label="openquake_v2_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v2_model.IMTValuesAttribute" class="md-nav__link">
    IMTValuesAttribute
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model" class="md-nav__link">
    openquake_v3_model
  </a>
  
    <nav class="md-nav" aria-label="openquake_v3_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation" class="md-nav__link">
    HazardAggregation
  </a>
  
    <nav class="md-nav" aria-label="HazardAggregation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.set_location" class="md-nav__link">
    set_location()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.to_csv" class="md-nav__link">
    to_csv()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel" class="md-nav__link">
    LocationIndexedModel
  </a>
  
    <nav class="md-nav" aria-label="LocationIndexedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel.set_location" class="md-nav__link">
    set_location()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization" class="md-nav__link">
    OpenquakeRealization
  </a>
  
    <nav class="md-nav" aria-label="OpenquakeRealization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.set_location" class="md-nav__link">
    set_location()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta" class="md-nav__link">
    ToshiOpenquakeMeta
  </a>
  
    <nav class="md-nav" aria-label="ToshiOpenquakeMeta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.vs30_nloc001_gt_rlz_index" class="md-nav__link">
    vs30_nloc001_gt_rlz_index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.vs30_nloc1_gt_rlz_index" class="md-nav__link">
    vs30_nloc1_gt_rlz_index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.drop_tables" class="md-nav__link">
    drop_tables()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.migrate" class="md-nav__link">
    migrate()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.multi_batch" class="md-nav__link">
    multi_batch
  </a>
  
    <nav class="md-nav" aria-label="multi_batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.multi_batch.DynamoBatchWorker" class="md-nav__link">
    DynamoBatchWorker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.oq_import" class="md-nav__link">
    oq_import
  </a>
  
    <nav class="md-nav" aria-label="oq_import">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.oq_import.export_v3" class="md-nav__link">
    export_v3
  </a>
  
    <nav class="md-nav" aria-label="export_v3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.oq_import.export_v3.export_meta_v3" class="md-nav__link">
    export_meta_v3()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.pynamodb_settings" class="md-nav__link">
    pynamodb_settings
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3" class="md-nav__link">
    query_v3
  </a>
  
    <nav class="md-nav" aria-label="query_v3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.first_vs30_key" class="md-nav__link">
    first_vs30_key()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.get_hazard_curves" class="md-nav__link">
    get_hazard_curves()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.get_hazard_metadata_v3" class="md-nav__link">
    get_hazard_metadata_v3()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.get_rlz_curves_v3" class="md-nav__link">
    get_rlz_curves_v3()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.have_mixed_length_vs30s" class="md-nav__link">
    have_mixed_length_vs30s()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.transform" class="md-nav__link">
    transform
  </a>
  
    <nav class="md-nav" aria-label="transform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.transform.parse_logic_tree_branches" class="md-nav__link">
    parse_logic_tree_branches()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.utils" class="md-nav__link">
    utils
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.utils.normalise_site_code" class="md-nav__link">
    normalise_site_code()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store" class="md-nav__link">
    toshi_hazard_store
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.config" class="md-nav__link">
    config
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.config.boolean_env" class="md-nav__link">
    boolean_env()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.gridded_hazard_query" class="md-nav__link">
    gridded_hazard_query
  </a>
  
    <nav class="md-nav" aria-label="gridded_hazard_query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.gridded_hazard_query.get_gridded_hazard" class="md-nav__link">
    get_gridded_hazard()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.gridded_hazard_query.get_one_gridded_hazard" class="md-nav__link">
    get_one_gridded_hazard()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.model" class="md-nav__link">
    model
  </a>
  
    <nav class="md-nav" aria-label="model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.drop_tables" class="md-nav__link">
    drop_tables()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.migrate" class="md-nav__link">
    migrate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard" class="md-nav__link">
    gridded_hazard
  </a>
  
    <nav class="md-nav" aria-label="gridded_hazard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.CompressedJsonicAttribute" class="md-nav__link">
    CompressedJsonicAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.CompressedListAttribute" class="md-nav__link">
    CompressedListAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.GriddedHazard" class="md-nav__link">
    GriddedHazard
  </a>
  
    <nav class="md-nav" aria-label="GriddedHazard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.GriddedHazard.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.drop_tables" class="md-nav__link">
    drop_tables()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.gridded_hazard.migrate" class="md-nav__link">
    migrate()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v1_model" class="md-nav__link">
    openquake_v1_model
  </a>
  
    <nav class="md-nav" aria-label="openquake_v1_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v1_model.LevelValuePairAttribute" class="md-nav__link">
    LevelValuePairAttribute
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v2_model" class="md-nav__link">
    openquake_v2_model
  </a>
  
    <nav class="md-nav" aria-label="openquake_v2_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v2_model.IMTValuesAttribute" class="md-nav__link">
    IMTValuesAttribute
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model" class="md-nav__link">
    openquake_v3_model
  </a>
  
    <nav class="md-nav" aria-label="openquake_v3_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation" class="md-nav__link">
    HazardAggregation
  </a>
  
    <nav class="md-nav" aria-label="HazardAggregation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.set_location" class="md-nav__link">
    set_location()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.to_csv" class="md-nav__link">
    to_csv()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel" class="md-nav__link">
    LocationIndexedModel
  </a>
  
    <nav class="md-nav" aria-label="LocationIndexedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel.set_location" class="md-nav__link">
    set_location()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization" class="md-nav__link">
    OpenquakeRealization
  </a>
  
    <nav class="md-nav" aria-label="OpenquakeRealization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.set_location" class="md-nav__link">
    set_location()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta" class="md-nav__link">
    ToshiOpenquakeMeta
  </a>
  
    <nav class="md-nav" aria-label="ToshiOpenquakeMeta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta.Meta" class="md-nav__link">
    Meta
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.vs30_nloc001_gt_rlz_index" class="md-nav__link">
    vs30_nloc001_gt_rlz_index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.vs30_nloc1_gt_rlz_index" class="md-nav__link">
    vs30_nloc1_gt_rlz_index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.drop_tables" class="md-nav__link">
    drop_tables()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.model.openquake_v3_model.migrate" class="md-nav__link">
    migrate()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.multi_batch" class="md-nav__link">
    multi_batch
  </a>
  
    <nav class="md-nav" aria-label="multi_batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.multi_batch.DynamoBatchWorker" class="md-nav__link">
    DynamoBatchWorker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.oq_import" class="md-nav__link">
    oq_import
  </a>
  
    <nav class="md-nav" aria-label="oq_import">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.oq_import.export_v3" class="md-nav__link">
    export_v3
  </a>
  
    <nav class="md-nav" aria-label="export_v3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.oq_import.export_v3.export_meta_v3" class="md-nav__link">
    export_meta_v3()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.pynamodb_settings" class="md-nav__link">
    pynamodb_settings
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3" class="md-nav__link">
    query_v3
  </a>
  
    <nav class="md-nav" aria-label="query_v3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.first_vs30_key" class="md-nav__link">
    first_vs30_key()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.get_hazard_curves" class="md-nav__link">
    get_hazard_curves()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.get_hazard_metadata_v3" class="md-nav__link">
    get_hazard_metadata_v3()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.get_rlz_curves_v3" class="md-nav__link">
    get_rlz_curves_v3()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.query_v3.have_mixed_length_vs30s" class="md-nav__link">
    have_mixed_length_vs30s()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.transform" class="md-nav__link">
    transform
  </a>
  
    <nav class="md-nav" aria-label="transform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.transform.parse_logic_tree_branches" class="md-nav__link">
    parse_logic_tree_branches()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#toshi_hazard_store.utils" class="md-nav__link">
    utils
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toshi_hazard_store.utils.normalise_site_code" class="md-nav__link">
    normalise_site_code()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/GNS-Science/toshi-hazard-store/edit/master/docs/api.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Modules</h1>
                
                <div class="doc doc-object doc-module">

<a id="toshi_hazard_store"></a>
    <div class="doc doc-contents first">

      <p>Top-level package for toshi-hazard-store.</p>



  <div class="doc doc-children">












  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.config" class="doc doc-heading">
        <code>config</code>



<a href="#toshi_hazard_store.config" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>This module exports comfiguration for the current system.</p>



  <div class="doc doc-children">












  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.config.boolean_env" class="doc doc-heading">
<code class="highlight language-python"><span class="n">boolean_env</span><span class="p">(</span><span class="n">environ_name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;FALSE&#39;</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.config.boolean_env" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Helper function.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">boolean_env</span><span class="p">(</span><span class="n">environ_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FALSE&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">environ_name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;YES&quot;</span><span class="p">,</span> <span class="s2">&quot;TRUE&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.gridded_hazard_query" class="doc doc-heading">
        <code>gridded_hazard_query</code>



<a href="#toshi_hazard_store.gridded_hazard_query" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Queries for saving and retrieving gridded hazard convenience.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.gridded_hazard_query.get_gridded_hazard" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_gridded_hazard</span><span class="p">(</span><span class="n">hazard_model_ids</span><span class="p">,</span> <span class="n">location_grid_ids</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">imts</span><span class="p">,</span> <span class="n">aggs</span><span class="p">,</span> <span class="n">poes</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.gridded_hazard_query.get_gridded_hazard" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Fetch GriddedHazard based on criteria.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/gridded_hazard_query.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_gridded_hazard</span><span class="p">(</span>
    <span class="n">hazard_model_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">location_grid_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">vs30s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">imts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">aggs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">poes</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">mGH</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Fetch GriddedHazard based on criteria.&quot;&quot;&quot;</span>

    <span class="c1"># partition_key = f&quot;{obj.hazard_model_id}&quot;</span>
    <span class="c1"># sort_key = f&quot;{obj.hazard_model_id}:{obj.location_grid_id}:{obj.vs30}:{obj.imt}:{obj.agg}:{obj.poe}&quot;</span>

    <span class="k">def</span> <span class="nf">build_sort_key</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">grid_ids</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">imts</span><span class="p">,</span> <span class="n">aggs</span><span class="p">,</span> <span class="n">poes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build sort_key.&quot;&quot;&quot;</span>

        <span class="n">sort_key</span> <span class="o">=</span> <span class="n">hazard_model_id</span>
        <span class="n">sort_key</span> <span class="o">=</span> <span class="n">sort_key</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">grid_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">grid_ids</span> <span class="k">else</span> <span class="n">sort_key</span>
        <span class="n">sort_key</span> <span class="o">=</span> <span class="n">sort_key</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">vs30s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">grid_ids</span> <span class="ow">and</span> <span class="n">vs30s</span> <span class="k">else</span> <span class="n">sort_key</span>
        <span class="n">sort_key</span> <span class="o">=</span> <span class="n">sort_key</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">imts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">grid_ids</span> <span class="ow">and</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">imts</span> <span class="k">else</span> <span class="n">sort_key</span>
        <span class="n">sort_key</span> <span class="o">=</span> <span class="n">sort_key</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">aggs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">grid_ids</span> <span class="ow">and</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">imts</span> <span class="ow">and</span> <span class="n">aggs</span> <span class="k">else</span> <span class="n">sort_key</span>
        <span class="n">sort_key</span> <span class="o">=</span> <span class="n">sort_key</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">poes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">grid_ids</span> <span class="ow">and</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">imts</span> <span class="ow">and</span> <span class="n">aggs</span> <span class="ow">and</span> <span class="n">poes</span> <span class="k">else</span> <span class="n">sort_key</span>
        <span class="k">return</span> <span class="n">sort_key</span>

    <span class="k">def</span> <span class="nf">build_condition_expr</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">location_grid_ids</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">imts</span><span class="p">,</span> <span class="n">aggs</span><span class="p">,</span> <span class="n">poes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build filter condition.&quot;&quot;&quot;</span>
        <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">mGH</span><span class="o">.</span><span class="n">hazard_model_id</span> <span class="o">==</span> <span class="n">hazard_model_id</span>
        <span class="k">if</span> <span class="n">location_grid_ids</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mGH</span><span class="o">.</span><span class="n">location_grid_id</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">location_grid_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vs30s</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mGH</span><span class="o">.</span><span class="n">vs30</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">vs30s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imts</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mGH</span><span class="o">.</span><span class="n">imt</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">imts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aggs</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mGH</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">aggs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">poes</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mGH</span><span class="o">.</span><span class="n">poe</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">poes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">condition_expr</span>

    <span class="c1"># TODO: this can be parallelised/optimised.</span>
    <span class="k">for</span> <span class="n">hazard_model_id</span> <span class="ow">in</span> <span class="n">hazard_model_ids</span><span class="p">:</span>

        <span class="n">sort_key_first_val</span> <span class="o">=</span> <span class="n">build_sort_key</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">location_grid_ids</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">imts</span><span class="p">,</span> <span class="n">aggs</span><span class="p">,</span> <span class="n">poes</span><span class="p">)</span>
        <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">build_condition_expr</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">location_grid_ids</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">imts</span><span class="p">,</span> <span class="n">aggs</span><span class="p">,</span> <span class="n">poes</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sort_key_first_val </span><span class="si">{</span><span class="n">sort_key_first_val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;condition_expr </span><span class="si">{</span><span class="n">condition_expr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sort_key_first_val</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="n">mGH</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">mGH</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">&gt;=</span> <span class="n">sort_key_first_val</span><span class="p">,</span> <span class="n">filter_condition</span><span class="o">=</span><span class="n">condition_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="n">mGH</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">hazard_model_id</span><span class="p">,</span>
                <span class="n">mGH</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">&gt;=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>  <span class="c1"># lowest printable char in ascii table is SPACE. (NULL is first control)</span>
                <span class="n">filter_condition</span><span class="o">=</span><span class="n">condition_expr</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_gridded_hazard: qry </span><span class="si">{</span><span class="n">qry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">qry</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.gridded_hazard_query.get_one_gridded_hazard" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_one_gridded_hazard</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">location_grid_id</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="n">imt</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">poe</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.gridded_hazard_query.get_one_gridded_hazard" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Fetch GriddedHazard based on single criteria.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/gridded_hazard_query.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_one_gridded_hazard</span><span class="p">(</span>
    <span class="n">hazard_model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">location_grid_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">vs30</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">imt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">agg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">poe</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">mGH</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Fetch GriddedHazard based on single criteria.&quot;&quot;&quot;</span>

    <span class="n">qry</span> <span class="o">=</span> <span class="n">mGH</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">mGH</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hazard_model_id</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">location_grid_id</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">vs30</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">imt</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">agg</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">poe</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_gridded_hazard: qry </span><span class="si">{</span><span class="n">qry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">qry</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.model" class="doc doc-heading">
        <code>model</code>



<a href="#toshi_hazard_store.model" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.model.drop_tables" class="doc doc-heading">
<code class="highlight language-python"><span class="n">drop_tables</span><span class="p">()</span></code>


<a href="#toshi_hazard_store.model.drop_tables" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Drop em</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/__init__.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">drop_tables</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Drop em&quot;&quot;&quot;</span>
    <span class="n">drop_tables_v3</span><span class="p">()</span>
    <span class="n">drop_gridded</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.model.migrate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">migrate</span><span class="p">()</span></code>


<a href="#toshi_hazard_store.model.migrate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Create the tables, unless they exist already.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/__init__.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">migrate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create the tables, unless they exist already.&quot;&quot;&quot;</span>
    <span class="n">migrate_v3</span><span class="p">()</span>
    <span class="n">migrate_gridded</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-module">



<h3 id="toshi_hazard_store.model.gridded_hazard" class="doc doc-heading">
        <code>gridded_hazard</code>



<a href="#toshi_hazard_store.model.gridded_hazard" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This module defines the pynamodb tables used to store THH.</p>



  <div class="doc doc-children">









  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.gridded_hazard.CompressedJsonicAttribute" class="doc doc-heading">
          <code>CompressedJsonicAttribute</code>



<a href="#toshi_hazard_store.model.gridded_hazard.CompressedJsonicAttribute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.attributes.Attribute">Attribute</span></code></p>


      <p>A compressed, json serialisable model attribute</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/gridded_hazard.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CompressedJsonicAttribute</span><span class="p">(</span><span class="n">Attribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A compressed, json serialisable model attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">attr_type</span> <span class="o">=</span> <span class="n">STRING</span>

    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compress_string</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># could this be pickle??</span>

    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decompress_string</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.gridded_hazard.CompressedListAttribute" class="doc doc-heading">
          <code>CompressedListAttribute</code>



<a href="#toshi_hazard_store.model.gridded_hazard.CompressedListAttribute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><a title="toshi_hazard_store.model.gridded_hazard.CompressedJsonicAttribute" href="#toshi_hazard_store.model.gridded_hazard.CompressedJsonicAttribute">CompressedJsonicAttribute</a></code></p>


      <p>A compressed list of floats attribute.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/gridded_hazard.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CompressedListAttribute</span><span class="p">(</span><span class="n">CompressedJsonicAttribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A compressed list of floats attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;value has invalid type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;; List[float])expected&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">











  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.gridded_hazard.GriddedHazard" class="doc doc-heading">
          <code>GriddedHazard</code>



<a href="#toshi_hazard_store.model.gridded_hazard.GriddedHazard" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.models.Model">Model</span></code></p>


      <p>Grid points defined in location_grid_id has a values in grid_poes.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/gridded_hazard.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">GriddedHazard</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid points defined in location_grid_id has a values in grid_poes.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

        <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_GriddedHazard-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
        <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>

    <span class="n">partition_key</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sort_key</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">range_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">VersionAttribute</span><span class="p">()</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">TimestampAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime_now</span><span class="p">)</span>

    <span class="n">hazard_model_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">location_grid_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>

    <span class="n">vs30</span> <span class="o">=</span> <span class="n">FloatAttribute</span><span class="p">()</span>
    <span class="n">imt</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">agg</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">poe</span> <span class="o">=</span> <span class="n">FloatAttribute</span><span class="p">()</span>

    <span class="n">grid_poes</span> <span class="o">=</span> <span class="n">CompressedListAttribute</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">new_model</span><span class="p">(</span><span class="n">hazard_model_id</span><span class="p">,</span> <span class="n">location_grid_id</span><span class="p">,</span> <span class="n">vs30</span><span class="p">,</span> <span class="n">imt</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">poe</span><span class="p">,</span> <span class="n">grid_poes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;GriddedHazard&#39;</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">GriddedHazard</span><span class="p">(</span>
            <span class="n">hazard_model_id</span><span class="o">=</span><span class="n">hazard_model_id</span><span class="p">,</span>
            <span class="n">location_grid_id</span><span class="o">=</span><span class="n">location_grid_id</span><span class="p">,</span>
            <span class="n">vs30</span><span class="o">=</span><span class="n">vs30</span><span class="p">,</span>
            <span class="n">imt</span><span class="o">=</span><span class="n">imt</span><span class="p">,</span>
            <span class="n">agg</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span>
            <span class="n">poe</span><span class="o">=</span><span class="n">poe</span><span class="p">,</span>
            <span class="n">grid_poes</span><span class="o">=</span><span class="n">grid_poes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">hazard_model_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">hazard_model_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">location_grid_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">vs30</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">imt</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">agg</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">poe</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">obj</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">


















  <div class="doc doc-object doc-class">



<h5 id="toshi_hazard_store.model.gridded_hazard.GriddedHazard.Meta" class="doc doc-heading">
          <code>Meta</code>



<a href="#toshi_hazard_store.model.gridded_hazard.GriddedHazard.Meta" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


      <p>DynamoDB Metadata.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/gridded_hazard.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

    <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_GriddedHazard-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
    <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">














  </div>

    </div>

  </div>







  </div>

    </div>

  </div>





  <div class="doc doc-object doc-function">



<h4 id="toshi_hazard_store.model.gridded_hazard.drop_tables" class="doc doc-heading">
<code class="highlight language-python"><span class="n">drop_tables</span><span class="p">()</span></code>


<a href="#toshi_hazard_store.model.gridded_hazard.drop_tables" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

      <p>Drop the tables, if they exist.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/gridded_hazard.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">drop_tables</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Drop the tables, if they exist.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">table</span><span class="o">.</span><span class="n">delete_table</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;deleted table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="toshi_hazard_store.model.gridded_hazard.migrate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">migrate</span><span class="p">()</span></code>


<a href="#toshi_hazard_store.model.gridded_hazard.migrate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

      <p>Create the tables, unless they exist already.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/gridded_hazard.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">migrate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create the tables, unless they exist already.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">table</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Migrate created table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Migrate created table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="toshi_hazard_store.model.openquake_v1_model" class="doc doc-heading">
        <code>openquake_v1_model</code>



<a href="#toshi_hazard_store.model.openquake_v1_model" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This module defines the pynamodb tables used to store openquake data.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v1_model.LevelValuePairAttribute" class="doc doc-heading">
          <code>LevelValuePairAttribute</code>



<a href="#toshi_hazard_store.model.openquake_v1_model.LevelValuePairAttribute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.attributes.MapAttribute">MapAttribute</span></code></p>


      <p>Store the IMT level and the POE value at the level.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v1_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LevelValuePairAttribute</span><span class="p">(</span><span class="n">MapAttribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store the IMT level and the POE value at the level.&quot;&quot;&quot;</span>

    <span class="n">lvl</span> <span class="o">=</span> <span class="n">NumberAttribute</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">NumberAttribute</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">












  </div>

    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="toshi_hazard_store.model.openquake_v2_model" class="doc doc-heading">
        <code>openquake_v2_model</code>



<a href="#toshi_hazard_store.model.openquake_v2_model" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This module defines the pynamodb tables used to store openquake v2 data.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v2_model.IMTValuesAttribute" class="doc doc-heading">
          <code>IMTValuesAttribute</code>



<a href="#toshi_hazard_store.model.openquake_v2_model.IMTValuesAttribute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.attributes.MapAttribute">MapAttribute</span></code></p>


      <p>Store the IntensityMeasureType e.g.(PGA, SA(N)) and the levels and values lists.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v2_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">IMTValuesAttribute</span><span class="p">(</span><span class="n">MapAttribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store the IntensityMeasureType e.g.(PGA, SA(N)) and the levels and values lists.&quot;&quot;&quot;</span>

    <span class="n">imt</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">lvls</span> <span class="o">=</span> <span class="n">ListAttribute</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="n">NumberAttribute</span><span class="p">)</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">ListAttribute</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="n">NumberAttribute</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="toshi_hazard_store.model.openquake_v3_model" class="doc doc-heading">
        <code>openquake_v3_model</code>



<a href="#toshi_hazard_store.model.openquake_v3_model" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This module defines the pynamodb tables used to store openquake data. Third iteration</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v3_model.HazardAggregation" class="doc doc-heading">
          <code>HazardAggregation</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><a title="toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel" href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel">LocationIndexedModel</a></code></p>


      <p>Stores aggregate hazard curves.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">HazardAggregation</span><span class="p">(</span><span class="n">LocationIndexedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores aggregate hazard curves.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

        <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_HazardAggregation-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
        <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>

    <span class="n">hazard_model_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">imt</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">agg</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">ListAttribute</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="n">LevelValuePairAttribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">CodedLocation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set internal fields, indices etc from the location.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

        <span class="c1"># update the indices</span>
        <span class="n">vs30s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">VS30_KEYLEN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nloc_001</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">vs30s</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">imt</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hazard_model_id</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s1">&#39;HazardAggregation&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Generate lists ready for csv module - including a header, followed by n rows.&quot;&quot;&quot;</span>
        <span class="n">n_models</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="c1"># create the header row, removing unneeded attributes</span>
            <span class="k">if</span> <span class="n">n_models</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">model_attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">attribute_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;hazard_model_id&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;uniq_id&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;created&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nloc_0&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nloc_001&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nloc_01&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nloc_1&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;partition_key&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;sort_key&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;values&#39;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="n">model_attrs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

                <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;poe-</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">lvl</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">model_attrs</span> <span class="o">+</span> <span class="n">levels</span><span class="p">)</span>

            <span class="c1"># the data</span>
            <span class="k">yield</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">model_attrs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="n">n_models</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">











  <div class="doc doc-object doc-class">



<h5 id="toshi_hazard_store.model.openquake_v3_model.HazardAggregation.Meta" class="doc doc-heading">
          <code>Meta</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.Meta" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


      <p>DynamoDB Metadata.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

    <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_HazardAggregation-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
    <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">














  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="toshi_hazard_store.model.openquake_v3_model.HazardAggregation.set_location" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_location</span><span class="p">(</span><span class="n">location</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.set_location" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

      <p>Set internal fields, indices etc from the location.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">CodedLocation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set internal fields, indices etc from the location.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

    <span class="c1"># update the indices</span>
    <span class="n">vs30s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">VS30_KEYLEN</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nloc_001</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">vs30s</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">imt</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hazard_model_id</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="toshi_hazard_store.model.openquake_v3_model.HazardAggregation.to_csv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">to_csv</span><span class="p">(</span><span class="n">models</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#toshi_hazard_store.model.openquake_v3_model.HazardAggregation.to_csv" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

      <p>Generate lists ready for csv module - including a header, followed by n rows.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s1">&#39;HazardAggregation&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;Generate lists ready for csv module - including a header, followed by n rows.&quot;&quot;&quot;</span>
    <span class="n">n_models</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="c1"># create the header row, removing unneeded attributes</span>
        <span class="k">if</span> <span class="n">n_models</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model_attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">attribute_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;hazard_model_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;uniq_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;created&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nloc_0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nloc_001&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nloc_01&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nloc_1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;partition_key&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sort_key&#39;</span><span class="p">,</span>
                <span class="s1">&#39;values&#39;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">model_attrs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

            <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;poe-</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">lvl</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">model_attrs</span> <span class="o">+</span> <span class="n">levels</span><span class="p">)</span>

        <span class="c1"># the data</span>
        <span class="k">yield</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">model_attrs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">n_models</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel" class="doc doc-heading">
          <code>LocationIndexedModel</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.models.Model">Model</span></code></p>


      <p>Model base class.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LocationIndexedModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model base class.&quot;&quot;&quot;</span>

    <span class="n">partition_key</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># For this we will use a downsampled location to 1.0 degree</span>
    <span class="n">sort_key</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">range_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">nloc_001</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>  <span class="c1"># 0.001deg ~100m grid</span>
    <span class="n">nloc_01</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>  <span class="c1"># 0.01deg ~1km grid</span>
    <span class="n">nloc_1</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>  <span class="c1"># 0.1deg ~10km grid</span>
    <span class="n">nloc_0</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>  <span class="c1"># 1.0deg ~100km grid</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">VersionAttribute</span><span class="p">()</span>
    <span class="n">uniq_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="n">FloatAttribute</span><span class="p">()</span>  <span class="c1"># latitude decimal degrees</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">FloatAttribute</span><span class="p">()</span>  <span class="c1"># longitude decimal degrees</span>
    <span class="n">vs30</span> <span class="o">=</span> <span class="n">FloatAttribute</span><span class="p">()</span>

    <span class="n">created</span> <span class="o">=</span> <span class="n">TimestampAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime_now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">CodedLocation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set internal fields, indices etc from the location.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nloc_001</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nloc_01</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nloc_0</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
        <span class="c1"># self.nloc_10 = location.downsample(10.0).code</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uniq_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">




















  <div class="doc doc-object doc-function">



<h5 id="toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel.set_location" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_location</span><span class="p">(</span><span class="n">location</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel.set_location" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

      <p>Set internal fields, indices etc from the location.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">CodedLocation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set internal fields, indices etc from the location.&quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nloc_001</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nloc_01</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nloc_0</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
    <span class="c1"># self.nloc_10 = location.downsample(10.0).code</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">lat</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">lon</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uniq_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization" class="doc doc-heading">
          <code>OpenquakeRealization</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><a title="toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel" href="#toshi_hazard_store.model.openquake_v3_model.LocationIndexedModel">LocationIndexedModel</a></code></p>


      <p>Stores the individual hazard realisation curves.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">OpenquakeRealization</span><span class="p">(</span><span class="n">LocationIndexedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores the individual hazard realisation curves.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

        <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_OpenquakeRealization-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
        <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>

    <span class="n">hazard_solution_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">source_tags</span> <span class="o">=</span> <span class="n">UnicodeSetAttribute</span><span class="p">()</span>
    <span class="n">source_ids</span> <span class="o">=</span> <span class="n">UnicodeSetAttribute</span><span class="p">()</span>

    <span class="n">rlz</span> <span class="o">=</span> <span class="n">IntegerAttribute</span><span class="p">()</span>  <span class="c1"># index of the openquake realization</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">ListAttribute</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="n">IMTValuesAttribute</span><span class="p">)</span>

    <span class="c1"># Secondary Index attributes</span>
    <span class="n">index1</span> <span class="o">=</span> <span class="n">vs30_nloc1_gt_rlz_index</span><span class="p">()</span>
    <span class="n">index1_rk</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">CodedLocation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set internal fields, indices etc from the location.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

        <span class="c1"># update the indices</span>
        <span class="n">rlzs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlz</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="n">vs30s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">VS30_KEYLEN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nloc_001</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">vs30s</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">rlzs</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hazard_solution_id</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index1_rk</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">vs30s</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">rlzs</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hazard_solution_id</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">














  <div class="doc doc-object doc-class">



<h5 id="toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.Meta" class="doc doc-heading">
          <code>Meta</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.Meta" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


      <p>DynamoDB Metadata.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

    <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_OpenquakeRealization-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
    <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">














  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.set_location" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_location</span><span class="p">(</span><span class="n">location</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.model.openquake_v3_model.OpenquakeRealization.set_location" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">

      <p>Set internal fields, indices etc from the location.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">CodedLocation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set internal fields, indices etc from the location.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

    <span class="c1"># update the indices</span>
    <span class="n">rlzs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlz</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">vs30s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs30</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">VS30_KEYLEN</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nloc_001</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">vs30s</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">rlzs</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hazard_solution_id</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">index1_rk</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nloc_1</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">vs30s</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">rlzs</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hazard_solution_id</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta" class="doc doc-heading">
          <code>ToshiOpenquakeMeta</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.models.Model">Model</span></code></p>


      <p>Stores metadata from the job configuration and the oq HDF5.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ToshiOpenquakeMeta</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores metadata from the job configuration and the oq HDF5.&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

        <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_WIP_OpenquakeMeta-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
        <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>

    <span class="n">partition_key</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># a static value as we actually don&#39;t want to partition our data</span>
    <span class="n">hazsol_vs30_rk</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">range_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">VersionAttribute</span><span class="p">()</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">TimestampAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime_now</span><span class="p">)</span>

    <span class="n">hazard_solution_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">general_task_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>
    <span class="n">vs30</span> <span class="o">=</span> <span class="n">NumberAttribute</span><span class="p">()</span>  <span class="c1"># vs30 value</span>

    <span class="n">imts</span> <span class="o">=</span> <span class="n">UnicodeSetAttribute</span><span class="p">()</span>  <span class="c1"># list of IMTs</span>
    <span class="n">locations_id</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">()</span>  <span class="c1"># Location codes identifier (ENUM?)</span>
    <span class="n">source_ids</span> <span class="o">=</span> <span class="n">UnicodeSetAttribute</span><span class="p">()</span>
    <span class="n">source_tags</span> <span class="o">=</span> <span class="n">UnicodeSetAttribute</span><span class="p">()</span>
    <span class="n">inv_time</span> <span class="o">=</span> <span class="n">NumberAttribute</span><span class="p">()</span>  <span class="c1"># Invesigation time in years</span>

    <span class="c1"># extracted from the OQ HDF5</span>
    <span class="n">src_lt</span> <span class="o">=</span> <span class="n">JSONAttribute</span><span class="p">()</span>  <span class="c1"># sources meta as DataFrame JSON</span>
    <span class="n">gsim_lt</span> <span class="o">=</span> <span class="n">JSONAttribute</span><span class="p">()</span>  <span class="c1"># gmpe meta as DataFrame JSON</span>
    <span class="n">rlz_lt</span> <span class="o">=</span> <span class="n">JSONAttribute</span><span class="p">()</span>  <span class="c1"># realization meta as DataFrame JSON</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">






















  <div class="doc doc-object doc-class">



<h5 id="toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta.Meta" class="doc doc-heading">
          <code>Meta</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.ToshiOpenquakeMeta.Meta" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">


      <p>DynamoDB Metadata.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;DynamoDB Metadata.&quot;&quot;&quot;</span>

    <span class="n">billing_mode</span> <span class="o">=</span> <span class="s1">&#39;PAY_PER_REQUEST&#39;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;THS_WIP_OpenquakeMeta-</span><span class="si">{</span><span class="n">DEPLOYMENT_STAGE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">REGION</span>
    <span class="k">if</span> <span class="n">IS_OFFLINE</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>  <span class="c1"># pragma: no cover</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">














  </div>

    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v3_model.vs30_nloc001_gt_rlz_index" class="doc doc-heading">
          <code>vs30_nloc001_gt_rlz_index</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.vs30_nloc001_gt_rlz_index" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.indexes.LocalSecondaryIndex">LocalSecondaryIndex</span></code></p>


      <p>Local secondary index with vs30:nloc_001:gtid:rlz6) 0.001 Degree search resolution</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">vs30_nloc001_gt_rlz_index</span><span class="p">(</span><span class="n">LocalSecondaryIndex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Local secondary index with vs30:nloc_001:gtid:rlz6) 0.001 Degree search resolution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="c1"># All attributes are projected</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">AllProjection</span><span class="p">()</span>

    <span class="n">partition_key</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Same as the base table</span>
    <span class="n">index2_rk</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">range_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="toshi_hazard_store.model.openquake_v3_model.vs30_nloc1_gt_rlz_index" class="doc doc-heading">
          <code>vs30_nloc1_gt_rlz_index</code>



<a href="#toshi_hazard_store.model.openquake_v3_model.vs30_nloc1_gt_rlz_index" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code><span title="pynamodb.indexes.LocalSecondaryIndex">LocalSecondaryIndex</span></code></p>


      <p>Local secondary index with vs#) + 0.1 Degree search resolution</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">vs30_nloc1_gt_rlz_index</span><span class="p">(</span><span class="n">LocalSecondaryIndex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Local secondary index with vs#) + 0.1 Degree search resolution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="c1"># All attributes are projected</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">AllProjection</span><span class="p">()</span>

    <span class="n">partition_key</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Same as the base table</span>
    <span class="n">index1_rk</span> <span class="o">=</span> <span class="n">UnicodeAttribute</span><span class="p">(</span><span class="n">range_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>





  <div class="doc doc-object doc-function">



<h4 id="toshi_hazard_store.model.openquake_v3_model.drop_tables" class="doc doc-heading">
<code class="highlight language-python"><span class="n">drop_tables</span><span class="p">()</span></code>


<a href="#toshi_hazard_store.model.openquake_v3_model.drop_tables" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

      <p>Drop the tables, if they exist.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">drop_tables</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Drop the tables, if they exist.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">table</span><span class="o">.</span><span class="n">delete_table</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;deleted table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="toshi_hazard_store.model.openquake_v3_model.migrate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">migrate</span><span class="p">()</span></code>


<a href="#toshi_hazard_store.model.openquake_v3_model.migrate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

      <p>Create the tables, unless they exist already.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/model/openquake_v3_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">migrate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create the tables, unless they exist already.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">table</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Migrate created table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Migrate created table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.multi_batch" class="doc doc-heading">
        <code>multi_batch</code>



<a href="#toshi_hazard_store.multi_batch" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="toshi_hazard_store.multi_batch.DynamoBatchWorker" class="doc doc-heading">
          <code>DynamoBatchWorker</code>



<a href="#toshi_hazard_store.multi_batch.DynamoBatchWorker" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
        <p class="doc doc-class-bases">
          Bases: <code>multiprocessing.<span title="multiprocessing.Process">Process</span></code></p>


      <p>A worker that batches and saves records to DynamoDB.</p>
<p>based on https://pymotw.com/2/multiprocessing/communication.html example 2.</p>


          <details class="quote">
            <summary>Source code in <code>toshi_hazard_store/multi_batch.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DynamoBatchWorker</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A worker that batches and saves records to DynamoDB.</span>

<span class="sd">    based on https://pymotw.com/2/multiprocessing/communication.html example 2.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_queue</span><span class="p">,</span> <span class="n">toshi_id</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span> <span class="o">=</span> <span class="n">task_queue</span>
        <span class="c1"># self.result_queue = result_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toshi_id</span> <span class="o">=</span> <span class="n">toshi_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;worker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> running with batch size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">proc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">next_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">next_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Poison pill means shutdown</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: Exiting&#39;</span> <span class="o">%</span> <span class="n">proc_name</span><span class="p">)</span>
                <span class="c1"># finally</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_batch_save</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="k">break</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_task</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_save</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
                <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="c1"># self.result_queue.put(answer)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_batch_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
        <span class="c1"># print(f&quot;worker {self.name} saving batch of len: {len(models)}&quot;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">ToshiOpenquakeHazardCurveStatsV2</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">batch_save_hcurve_stats_v2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toshi_id</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">ToshiOpenquakeHazardCurveRlzsV2</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">batch_save_hcurve_rlzs_v2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toshi_id</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">OpenquakeRealization</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">OpenquakeRealization</span><span class="o">.</span><span class="n">batch_write</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;WHATT!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>



  <div class="doc doc-children">

















  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.oq_import" class="doc doc-heading">
        <code>oq_import</code>



<a href="#toshi_hazard_store.oq_import" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-module">



<h3 id="toshi_hazard_store.oq_import.export_v3" class="doc doc-heading">
        <code>export_v3</code>



<a href="#toshi_hazard_store.oq_import.export_v3" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-function">



<h4 id="toshi_hazard_store.oq_import.export_v3.export_meta_v3" class="doc doc-heading">
<code class="highlight language-python"><span class="n">export_meta_v3</span><span class="p">(</span><span class="n">dstore</span><span class="p">,</span> <span class="n">toshi_hazard_id</span><span class="p">,</span> <span class="n">toshi_gt_id</span><span class="p">,</span> <span class="n">locations_id</span><span class="p">,</span> <span class="n">source_tags</span><span class="p">,</span> <span class="n">source_ids</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.oq_import.export_v3.export_meta_v3" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

      <p>Extract and same the meta data.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/oq_import/export_v3.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">export_meta_v3</span><span class="p">(</span><span class="n">dstore</span><span class="p">,</span> <span class="n">toshi_hazard_id</span><span class="p">,</span> <span class="n">toshi_gt_id</span><span class="p">,</span> <span class="n">locations_id</span><span class="p">,</span> <span class="n">source_tags</span><span class="p">,</span> <span class="n">source_ids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract and same the meta data.&quot;&quot;&quot;</span>
    <span class="n">oq</span> <span class="o">=</span> <span class="n">dstore</span><span class="p">[</span><span class="s1">&#39;oqparam&#39;</span><span class="p">]</span>
    <span class="n">source_lt</span><span class="p">,</span> <span class="n">gsim_lt</span><span class="p">,</span> <span class="n">rlz_lt</span> <span class="o">=</span> <span class="n">parse_logic_tree_branches</span><span class="p">(</span><span class="n">dstore</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">df_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_lt</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
    <span class="n">df_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gsim_lt</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
    <span class="n">df_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rlz_lt</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">df_len</span> <span class="o">&gt;=</span> <span class="mf">300e3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Dataframes for this job may be too large to store on DynamoDB.&#39;</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ToshiOpenquakeMeta</span><span class="p">(</span>
        <span class="n">partition_key</span><span class="o">=</span><span class="s2">&quot;ToshiOpenquakeMeta&quot;</span><span class="p">,</span>
        <span class="n">hazard_solution_id</span><span class="o">=</span><span class="n">toshi_hazard_id</span><span class="p">,</span>
        <span class="n">general_task_id</span><span class="o">=</span><span class="n">toshi_gt_id</span><span class="p">,</span>
        <span class="n">hazsol_vs30_rk</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">toshi_hazard_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">oq</span><span class="o">.</span><span class="n">reference_vs30_value</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="c1"># updated=dt.datetime.now(tzutc()),</span>
        <span class="c1"># known at configuration</span>
        <span class="n">vs30</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">oq</span><span class="o">.</span><span class="n">reference_vs30_value</span><span class="p">),</span>  <span class="c1"># vs30 value</span>
        <span class="n">imts</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">oq</span><span class="o">.</span><span class="n">imtls</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>  <span class="c1"># list of IMTs</span>
        <span class="n">locations_id</span><span class="o">=</span><span class="n">locations_id</span><span class="p">,</span>  <span class="c1"># Location code or list ID</span>
        <span class="n">source_tags</span><span class="o">=</span><span class="n">source_tags</span><span class="p">,</span>
        <span class="n">source_ids</span><span class="o">=</span><span class="n">source_ids</span><span class="p">,</span>
        <span class="n">inv_time</span><span class="o">=</span><span class="nb">vars</span><span class="p">(</span><span class="n">oq</span><span class="p">)[</span><span class="s1">&#39;investigation_time&#39;</span><span class="p">],</span>
        <span class="n">src_lt</span><span class="o">=</span><span class="n">source_lt</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>  <span class="c1"># sources meta as DataFrame JSON</span>
        <span class="n">gsim_lt</span><span class="o">=</span><span class="n">gsim_lt</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>  <span class="c1"># gmpe meta as DataFrame JSON</span>
        <span class="n">rlz_lt</span><span class="o">=</span><span class="n">rlz_lt</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>  <span class="c1"># realization meta as DataFrame JSON</span>
    <span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">OpenquakeMeta</span><span class="p">(</span><span class="n">source_lt</span><span class="p">,</span> <span class="n">gsim_lt</span><span class="p">,</span> <span class="n">rlz_lt</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.pynamodb_settings" class="doc doc-heading">
        <code>pynamodb_settings</code>



<a href="#toshi_hazard_store.pynamodb_settings" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>pynamodb_settings.</p>
<p>Default settings may be overridden by providing a Python module which exports the desired new values. Set the
PYNAMODB_CONFIG environment variable to an absolute path to this module or write it to /etc/pynamodb/
global_default_settings.py to have it automatically discovered.</p>



  <div class="doc doc-children">















  </div>

    </div>

  </div>




  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.query_v3" class="doc doc-heading">
        <code>query_v3</code>



<a href="#toshi_hazard_store.query_v3" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Queries for saving and retrieving openquake hazard results with convenience.</p>



  <div class="doc doc-children">













  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.query_v3.first_vs30_key" class="doc doc-heading">
<code class="highlight language-python"><span class="n">first_vs30_key</span><span class="p">(</span><span class="n">vs30s</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.query_v3.first_vs30_key" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>This function handles vs30 index keys with variable length (3 or 4), which occur since the addition
of vs30 values 1000 &amp; 1500.</p>
<p>DynamoDB sort key is not mutable, so we must handle this in our query instead, which is slighlty less
efficient. Leave this in place unldess the table can be rewritten with a new vs30 key length of 4 characters.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/query_v3.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">first_vs30_key</span><span class="p">(</span><span class="n">vs30s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function handles vs30 index keys with variable length (3 or 4), which occur since the addition</span>
<span class="sd">    of vs30 values 1000 &amp; 1500.</span>

<span class="sd">    DynamoDB sort key is not mutable, so we must handle this in our query instead, which is slighlty less</span>
<span class="sd">    efficient. Leave this in place unldess the table can be rewritten with a new vs30 key length of 4 characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">have_mixed_length_vs30s</span><span class="p">(</span><span class="n">vs30s</span><span class="p">):</span>
        <span class="n">vsLong</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vsLong</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">VS30_KEYLEN</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vs30s</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">VS30_KEYLEN</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.query_v3.get_hazard_curves" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_hazard_curves</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[],</span> <span class="n">vs30s</span><span class="o">=</span><span class="p">[],</span> <span class="n">hazard_model_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">imts</span><span class="o">=</span><span class="p">[],</span> <span class="n">aggs</span><span class="o">=</span><span class="p">[])</span></code>


<a href="#toshi_hazard_store.query_v3.get_hazard_curves" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Use mHAG.sort_key as much as possible.</p>
<p>f'{nloc_001}:{vs30s}:{hazard_model_id}'</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/query_v3.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_hazard_curves</span><span class="p">(</span>
    <span class="n">locs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># nloc_001</span>
    <span class="n">vs30s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># vs30s</span>
    <span class="n">hazard_model_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># hazard_model_ids</span>
    <span class="n">imts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">aggs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">mHAG</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Use mHAG.sort_key as much as possible.</span>


<span class="sd">    f&#39;{nloc_001}:{vs30s}:{hazard_model_id}&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">build_condition_expr</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">hids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build filter condition.&quot;&quot;&quot;</span>
        <span class="c1">## TODO REFACTOR ME ... using the res of first loc is not ideal</span>
        <span class="n">grid_res</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">locs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">places</span> <span class="o">=</span> <span class="n">grid_res</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span><span class="o">.</span><span class="n">exponent</span>

        <span class="c1"># print()</span>
        <span class="c1"># print(f&#39;places {places} loc[0] {locs[0]}&#39;)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="n">places</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">downsample_code</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">]</span>

        <span class="n">condition_expr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">places</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">nloc_1</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">locs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">places</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">nloc_01</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">locs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">places</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">nloc_001</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">locs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vs30s</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">vs30</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">vs30s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imts</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">imt</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">imts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aggs</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">aggs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hids</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">hazard_model_id</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">hids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">condition_expr</span>

    <span class="k">def</span> <span class="nf">build_sort_key</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">hids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build sort_key.&quot;&quot;&quot;</span>
        <span class="n">sort_key_first_val</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">first_loc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">locs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># these need to be formatted to match the sort key 0.001 ?</span>
        <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_loc</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">vs30s</span><span class="p">:</span>
            <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">first_vs30_key</span><span class="p">(</span><span class="n">vs30s</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">have_mixed_length_vs30s</span><span class="p">(</span><span class="n">vs30s</span><span class="p">):</span>  <span class="c1"># we must stop the sort_key build here</span>
                <span class="k">return</span> <span class="n">sort_key_first_val</span>
        <span class="k">if</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">imts</span><span class="p">:</span>
            <span class="n">first_imt</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">first_imt</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">imts</span> <span class="ow">and</span> <span class="n">aggs</span><span class="p">:</span>
            <span class="n">first_agg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">aggs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">first_agg</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">imts</span> <span class="ow">and</span> <span class="n">aggs</span> <span class="ow">and</span> <span class="n">hids</span><span class="p">:</span>
            <span class="n">first_hid</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">first_hid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">sort_key_first_val</span>

    <span class="c1"># print(&#39;hashes&#39;, get_hashes(locs))</span>
    <span class="c1"># TODO: use https://pypi.org/project/InPynamoDB/</span>
    <span class="k">for</span> <span class="n">hash_location_code</span> <span class="ow">in</span> <span class="n">get_hashes</span><span class="p">(</span><span class="n">locs</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;hash_key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hash_location_code</span><span class="p">)</span>

        <span class="n">hash_locs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span> <span class="n">downsample_code</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">==</span> <span class="n">hash_location_code</span><span class="p">,</span> <span class="n">locs</span><span class="p">))</span>
        <span class="n">sort_key_first_val</span> <span class="o">=</span> <span class="n">build_sort_key</span><span class="p">(</span><span class="n">hash_locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">hazard_model_ids</span><span class="p">)</span>
        <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">build_condition_expr</span><span class="p">(</span><span class="n">hash_locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">hazard_model_ids</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sort_key_first_val: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sort_key_first_val</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;condition_expr: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">condition_expr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sort_key_first_val</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_location_code</span><span class="p">,</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">&gt;=</span> <span class="n">sort_key_first_val</span><span class="p">,</span> <span class="n">filter_condition</span><span class="o">=</span><span class="n">condition_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="n">mHAG</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">hash_location_code</span><span class="p">,</span>
                <span class="n">mHAG</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">&gt;=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>  <span class="c1"># lowest printable char in ascii table is SPACE. (NULL is first control)</span>
                <span class="n">filter_condition</span><span class="o">=</span><span class="n">condition_expr</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;get_hazard_rlz_curves_v3: qry </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qry</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">qry</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.query_v3.get_hazard_metadata_v3" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_hazard_metadata_v3</span><span class="p">(</span><span class="n">haz_sol_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vs30_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.query_v3.get_hazard_metadata_v3" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Fetch ToshiOpenquakeHazardMeta based on criteria.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/query_v3.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_hazard_metadata_v3</span><span class="p">(</span>
    <span class="n">haz_sol_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vs30_vals</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">mOQM</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Fetch ToshiOpenquakeHazardMeta based on criteria.&quot;&quot;&quot;</span>

    <span class="n">condition_expr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">haz_sol_ids</span><span class="p">:</span>
        <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mOQM</span><span class="o">.</span><span class="n">hazard_solution_id</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">haz_sol_ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vs30_vals</span><span class="p">:</span>
        <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mOQM</span><span class="o">.</span><span class="n">vs30</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">vs30_vals</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">mOQM</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="s2">&quot;ToshiOpenquakeMeta&quot;</span><span class="p">,</span> <span class="n">filter_condition</span><span class="o">=</span><span class="n">condition_expr</span>  <span class="c1"># NB the partition key is the table name!</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.query_v3.get_rlz_curves_v3" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_rlz_curves_v3</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[],</span> <span class="n">vs30s</span><span class="o">=</span><span class="p">[],</span> <span class="n">rlzs</span><span class="o">=</span><span class="p">[],</span> <span class="n">tids</span><span class="o">=</span><span class="p">[],</span> <span class="n">imts</span><span class="o">=</span><span class="p">[])</span></code>


<a href="#toshi_hazard_store.query_v3.get_rlz_curves_v3" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Use mRLZ.sort_key as much as possible.</p>
<p>f'{nloc_001}:{vs30s}:{rlzs}:{self.hazard_solution_id}'</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/query_v3.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_rlz_curves_v3</span><span class="p">(</span>
    <span class="n">locs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># nloc_001</span>
    <span class="n">vs30s</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># vs30s</span>
    <span class="n">rlzs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># rlzs</span>
    <span class="n">tids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># toshi hazard_solution_ids</span>
    <span class="n">imts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">mRLZ</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Use mRLZ.sort_key as much as possible.</span>


<span class="sd">    f&#39;{nloc_001}:{vs30s}:{rlzs}:{self.hazard_solution_id}&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">build_condition_expr</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">rlzs</span><span class="p">,</span> <span class="n">tids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build filter condition.&quot;&quot;&quot;</span>
        <span class="c1">## TODO REFACTOR ME ... using the res of first loc is not ideal</span>
        <span class="n">grid_res</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">locs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">places</span> <span class="o">=</span> <span class="n">grid_res</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span><span class="o">.</span><span class="n">exponent</span>

        <span class="c1"># print()</span>
        <span class="c1"># print(f&#39;places {places} loc[0] {locs[0]}&#39;)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="n">places</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">downsample_code</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">]</span>

        <span class="n">condition_expr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">places</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">nloc_1</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">locs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">places</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">nloc_01</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">locs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">places</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">nloc_001</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">locs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vs30s</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">vs30</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">vs30s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rlzs</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">rlz</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">rlzs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tids</span><span class="p">:</span>
            <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">condition_expr</span> <span class="o">&amp;</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">hazard_solution_id</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="o">*</span><span class="n">tids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">condition_expr</span>

    <span class="k">def</span> <span class="nf">build_sort_key</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">rlzs</span><span class="p">,</span> <span class="n">tids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build sort_key.&quot;&quot;&quot;</span>
        <span class="n">sort_key_first_val</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">first_loc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">locs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># these need to be formatted to match the sort key 0.001 ?</span>
        <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_loc</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">vs30s</span><span class="p">:</span>
            <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">first_vs30_key</span><span class="p">(</span><span class="n">vs30s</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">have_mixed_length_vs30s</span><span class="p">(</span><span class="n">vs30s</span><span class="p">):</span>  <span class="c1"># we must stop the sort_key build here</span>
                <span class="k">return</span> <span class="n">sort_key_first_val</span>
        <span class="k">if</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">rlzs</span><span class="p">:</span>
            <span class="n">first_rlz</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rlzs</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">first_rlz</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">vs30s</span> <span class="ow">and</span> <span class="n">rlzs</span> <span class="ow">and</span> <span class="n">tids</span><span class="p">:</span>
            <span class="n">first_tid</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sort_key_first_val</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">first_tid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">sort_key_first_val</span>

    <span class="c1"># print(&#39;hashes&#39;, get_hashes(locs))</span>
    <span class="c1"># TODO: use https://pypi.org/project/InPynamoDB/</span>
    <span class="k">for</span> <span class="n">hash_location_code</span> <span class="ow">in</span> <span class="n">get_hashes</span><span class="p">(</span><span class="n">locs</span><span class="p">):</span>

        <span class="c1"># print(f&#39;hash_key {hash_location_code}&#39;)</span>

        <span class="n">hash_locs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span> <span class="n">downsample_code</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">==</span> <span class="n">hash_location_code</span><span class="p">,</span> <span class="n">locs</span><span class="p">))</span>

        <span class="n">sort_key_first_val</span> <span class="o">=</span> <span class="n">build_sort_key</span><span class="p">(</span><span class="n">hash_locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">rlzs</span><span class="p">,</span> <span class="n">tids</span><span class="p">)</span>
        <span class="n">condition_expr</span> <span class="o">=</span> <span class="n">build_condition_expr</span><span class="p">(</span><span class="n">hash_locs</span><span class="p">,</span> <span class="n">vs30s</span><span class="p">,</span> <span class="n">rlzs</span><span class="p">,</span> <span class="n">tids</span><span class="p">)</span>

        <span class="c1"># print(f&#39;sort_key_first_val: {sort_key_first_val}&#39;)</span>
        <span class="c1"># print(f&#39;condition_expr: {condition_expr}&#39;)</span>

        <span class="c1"># expected_sort_key = &#39;-41.300~174.780:750:000000:A_CRU&#39;</span>
        <span class="c1"># expected_hash_key = &#39;-41.3~174.8&#39;</span>

        <span class="c1"># print()</span>
        <span class="c1"># print(expected_hash_key, expected_sort_key)</span>
        <span class="c1"># # assert 0</span>

        <span class="k">if</span> <span class="n">sort_key_first_val</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_location_code</span><span class="p">,</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">&gt;=</span> <span class="n">sort_key_first_val</span><span class="p">,</span> <span class="n">filter_condition</span><span class="o">=</span><span class="n">condition_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="n">mRLZ</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">hash_location_code</span><span class="p">,</span>
                <span class="n">mRLZ</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">&gt;=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>  <span class="c1"># lowest printable char in ascii table is SPACE. (NULL is first control)</span>
                <span class="n">filter_condition</span><span class="o">=</span><span class="n">condition_expr</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># print(f&quot;get_hazard_rlz_curves_v3: qry {qry}&quot;)</span>
        <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">qry</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imts</span><span class="p">:</span>
                <span class="n">hit</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">imt</span> <span class="ow">in</span> <span class="n">imts</span><span class="p">,</span> <span class="n">hit</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.query_v3.have_mixed_length_vs30s" class="doc doc-heading">
<code class="highlight language-python"><span class="n">have_mixed_length_vs30s</span><span class="p">(</span><span class="n">vs30s</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.query_v3.have_mixed_length_vs30s" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Does the list of vs30s require mixed length index keys.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/query_v3.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">have_mixed_length_vs30s</span><span class="p">(</span><span class="n">vs30s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Does the list of vs30s require mixed length index keys.&quot;&quot;&quot;</span>
    <span class="n">max_vs30</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vs30s</span><span class="p">)</span>
    <span class="n">min_vs30</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vs30s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_vs30</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">min_vs30</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.transform" class="doc doc-heading">
        <code>transform</code>



<a href="#toshi_hazard_store.transform" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Helper functions to export an openquake calculation and save it with toshi-hazard-store.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.transform.parse_logic_tree_branches" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_logic_tree_branches</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.transform.parse_logic_tree_branches" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Extract the dataframes.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/transform.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_logic_tree_branches</span><span class="p">(</span><span class="n">file_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract the dataframes.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
        <span class="c1"># read and prepare the source model logic tree for documentation</span>
        <span class="c1">### full_lt is a key that contains subkeys for each type of logic tree</span>
        <span class="c1">### here we read the contents of source_model_lt into a dataframe</span>
        <span class="n">source_lt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;full_lt&#39;</span><span class="p">][</span><span class="s1">&#39;source_model_lt&#39;</span><span class="p">][:])</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">source_lt</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">source_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_lt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

        <span class="c1"># identify the source labels used in the realizations table</span>
        <span class="n">source_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;branch_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BASE183</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_lt</span><span class="p">)]]</span>
        <span class="n">source_lt</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;branch_code&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># read and prepare the gsim logic tree for documentation</span>
        <span class="c1">### full_lt is a key that contains subkeys for each type of logic tree</span>
        <span class="c1">### here we read the contents of gsim_lt into a dataframe</span>
        <span class="n">gsim_lt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;full_lt&#39;</span><span class="p">][</span><span class="s1">&#39;gsim_lt&#39;</span><span class="p">][:])</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gsim_lt</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">gsim_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsim_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

        <span class="c1"># break up the gsim df into tectonic regions (one df per column of gsims in realization labels. e.g. A~AAA)</span>
        <span class="c1"># the order of the dictionary is consistent with the order of the columns</span>
        <span class="n">gsim_lt_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">gsim_lt</span><span class="p">[</span><span class="s1">&#39;trt&#39;</span><span class="p">])):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">gsim_lt</span><span class="p">[</span><span class="n">gsim_lt</span><span class="p">[</span><span class="s1">&#39;trt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">trt</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;branch_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;branch_code&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">### the branch code used to be a user specified string from the gsim logic tree .xml</span>
            <span class="c1">### now the only way to identify which regionalization is used is to extract it manually</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]):</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">[|</span><span class="se">\\</span><span class="s1">]|</span><span class="se">\n</span><span class="s1">region = </span><span class="se">\&quot;</span><span class="s1">|</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;model name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">tags</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;model name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">gsim_lt_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

    <span class="c1"># read and prep the realization record for documentation</span>
    <span class="c1">### this one can be read into a df directly from the dstore&#39;s full_lt</span>
    <span class="c1">### the column titled &#39;ordinal&#39; is dropped, as it will be the same as the 0-n index</span>
    <span class="n">dstore</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
    <span class="n">rlz_lt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dstore</span><span class="p">[</span><span class="s1">&#39;full_lt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rlzs</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;ordinal&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># add to the rlt_lt to note which source models and which gsims were used for each branch</span>
    <span class="k">for</span> <span class="n">i_rlz</span> <span class="ow">in</span> <span class="n">rlz_lt</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="c1"># rlz name is in the form A~AAA, with a single source identifier followed by characters for each trt region</span>
        <span class="n">srm_code</span><span class="p">,</span> <span class="n">gsim_codes</span> <span class="o">=</span> <span class="n">rlz_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_rlz</span><span class="p">,</span> <span class="s1">&#39;branch_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>

        <span class="c1"># copy over the source label</span>
        <span class="n">rlz_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_rlz</span><span class="p">,</span> <span class="s1">&#39;source combination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">srm_code</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">]</span>

        <span class="c1"># loop through the characters for the trt region and add the corresponding gsim name</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gsim_code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gsim_codes</span><span class="p">):</span>
            <span class="n">trt</span><span class="p">,</span> <span class="n">gsim</span> <span class="o">=</span> <span class="n">gsim_lt_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gsim_code</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;trt&#39;</span><span class="p">,</span> <span class="s1">&#39;model name&#39;</span><span class="p">]]</span>
            <span class="n">rlz_lt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_rlz</span><span class="p">,</span> <span class="n">trt</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsim</span>

    <span class="k">return</span> <span class="n">source_lt</span><span class="p">,</span> <span class="n">gsim_lt</span><span class="p">,</span> <span class="n">rlz_lt</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="toshi_hazard_store.utils" class="doc doc-heading">
        <code>utils</code>



<a href="#toshi_hazard_store.utils" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Common utilities.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h3 id="toshi_hazard_store.utils.normalise_site_code" class="doc doc-heading">
<code class="highlight language-python"><span class="n">normalise_site_code</span><span class="p">(</span><span class="n">oq_site_object</span><span class="p">,</span> <span class="n">force_normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#toshi_hazard_store.utils.normalise_site_code" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Return a valid code for storage.</p>

        <details class="quote">
          <summary>Source code in <code>toshi_hazard_store/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalise_site_code</span><span class="p">(</span><span class="n">oq_site_object</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">force_normalized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CodedLocation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return a valid code for storage.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oq_site_object</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown site object </span><span class="si">{</span><span class="n">oq_site_object</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">force_normalized</span> <span class="o">=</span> <span class="n">force_normalized</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oq_site_object</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oq_site_object</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">oq_site_object</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">oq_site_object</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">oq_site_object</span>

    <span class="n">rounded</span> <span class="o">=</span> <span class="n">CodedLocation</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_normalized</span><span class="p">:</span>
        <span class="n">rounded</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">oq_site_object</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>  <span class="c1"># restore the original location code</span>
    <span class="k">return</span> <span class="n">rounded</span>
</code></pre></div></td></tr></table></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  </div>

    </div>

  </div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../usage/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Usage
              </div>
            </div>
          </a>
        
        
          <a href="../contributing/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Contributing
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
      <a href="https://github.com/waynerv/cookiecutter-pypackage" target="_blank" rel="noopener" title="Tweet" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
      <a href="https://github.com/waynerv/cookiecutter-pypackage" target="_blank" rel="noopener" title="Facebook" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
      </a>
    
      
      
      <a href="https://github.com/GNS-Science/toshi-hazard-store" target="_blank" rel="noopener" title="Github" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
      <a href="mailto:chrisbc@artisan.co.nz" target="_blank" rel="noopener" title="" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 8l-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['navigation.indexes', 'navigation.instant', 'navigation.tabs.sticky'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>